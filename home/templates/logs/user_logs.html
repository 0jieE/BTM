{% extends 'layouts/base.html' %}
{% load static %}
{% load business_tags %}
{% block title %}User Logs{% endblock title %}
{% block extrastyle %}
<link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}">
<style>
    .content-wrapper {
        padding: 20px;
        background-color: #2c2f33; /* Dark background for the entire content */
    }

    .card {
        background-color: #3a3f44;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        height: 80vh; /* Height for scrollable content */
        overflow-y: auto; /* Enable vertical scrolling */
        position: relative;
    }

    .card h2 {
        color: #ffffff;
        font-size: 1.5rem;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 15px;
        position: sticky; /* Make header sticky */
        top: -20px; /* Stick to the top */
        background-color: #3a3f44; 
        z-index: 10; /* Ensure header is above content */
        padding-top: 10px;
    }

    .user-list ul, .user-logs ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .user-list li {
        background-color: #454a52;
        margin-bottom: 10px;
        border-radius: 5px;
        padding: 10px;
        transition: background-color 0.3s, transform 0.3s;
        cursor: pointer;
        font-size: 1.125rem;
        color: #ffffff;
    }

    .user-list li:hover {
        background-color: #007bff;
        transform: translateY(-2px);
        color: #ffffff;
    }

    .user-logs li {
        background-color: #3e444b;
        margin-bottom: 10px;
        border-radius: 5px;
        padding: 10px;
        color: #ffffff;
        display: flex;
        flex-direction: column; /* Align content vertically */
    }

    .log-header {
        display: flex;
        justify-content: space-between; /* Aligns text and timestamp on opposite sides */
        align-items: center;
        margin-bottom: 10px;
    }

    .user-logs li:hover {
        background-color: #525861;
    }

    .user-logs p {
        color: #adb5bd;
    }

    .timestamp {
        color: #adb5bd;
        font-size: 0.875rem;
        white-space: nowrap; /* Prevents timestamp from wrapping */
    }

    .picture-container {
        display: flex;
        flex-wrap: wrap; /* Ensure pictures wrap if there's too many */
        margin-top: 10px;
    }

    .picture-container img {
        max-width: 100px;
        margin-right: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        transition: transform 0.3s;
    }

    .picture-container img:hover {
        transform: scale(1.1);
    }

    .user-logs .no-logs {
        color: #adb5bd;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .container {
            flex-direction: column;
        }

        .user-list, .user-logs {
            width: 100%;
            height: auto;
        }
    }
</style>
{% endblock extrastyle %}
{% block bodyclass %}sidebar-collapse sidebar-mini dark-mode layout-navbar-fixed layout-fixed{% endblock bodyclass %}
{% block content %}
<div class="content-wrapper">
    <section class="content">
        <div class="container-fluid business-container">
            <div class="row">
                <div class="col-lg-4 col-md-12">
                    <div class="card user-list">
                        <h2>Users</h2>
                        <ul>
                            {% for user in users %}
                                <li data-user-id="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-lg-8 col-md-12">
                    <div class="card user-logs">
                        <h2>User Logs</h2>
                        <div id="log-content">
                            <p class="no-logs">Select a user to view logs</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock content %}
{% block extra_scripts %}
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        $('.user-list li').on('click', function() {
            const userId = $(this).data('user-id');

            // Remove active class from all users and add to the clicked user
            $('.user-list li').removeClass('active');
            $(this).addClass('active');

            // Fetch the user logs
            fetch(`/get-user-logs/${userId}/`)
                .then(response => response.json())
                .then(data => {
                    const logContent = $('#log-content');
                    logContent.empty(); // Clear previous logs

                    if (data.logs.length > 0) {
                        const ul = $('<ul></ul>');
                        data.logs.forEach(log => {
                            const li = $('<li></li>');

                            const logHeader = $('<div></div>').addClass('log-header');
                            const actionText = `${log.action} at ${log.business}`;
                            const timestamp = $('<span></span>').addClass('timestamp').text(new Date(log.timestamp).toLocaleString());

                            logHeader.append($('<span></span>').text(actionText));
                            logHeader.append(timestamp);
                            li.append(logHeader);

                            // Check if there are pictures
                            if (log.pictures && log.pictures.length > 0) {
                                const pictureContainer = $('<div></div>').addClass('picture-container');
                                log.pictures.forEach(pic => {
                                    const img = $('<img>').attr('src', pic);
                                    pictureContainer.append(img);
                                });
                                li.append(pictureContainer);
                            }

                            ul.append(li);
                        });
                        logContent.append(ul);
                    } else {
                        logContent.html('<p class="no-logs">No logs available for this user.</p>');
                    }
                });
        });
    });
</script>
{% endblock extra_scripts %}
